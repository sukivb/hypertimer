/**
 * hypertimer.js
 * https://github.com/enmasseio/hypertimer
 *
 * Time control for simulations.
 *
 * Run a timer at a faster or slower pace than real-time, or run discrete events.
 *
 * @version 2.1.3
 * @date    2016-06-17
 *
 * @license
 * Copyright (C) 2014-2015 Almende B.V., http://almende.com
 *
 * Licensed under the Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License. You may obtain a copy
 * of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
 * License for the specific language governing permissions and limitations under
 * the License.
 */
!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n(require("ws"),require("debug")):"function"==typeof define&&define.amd?define(["ws","debug"],n):"object"==typeof exports?exports.hypertimer=n(require("ws"),require("debug")):t.hypertimer=n(t.ws,t.debug)}(this,function(t,n){return function(t){function n(r){if(e[r])return e[r].exports;var o=e[r]={exports:{},id:r,loaded:!1};return t[r].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}var e={};return n.m=t,n.c=e,n.p="",n(0)}([function(t,n,e){t.exports=e(1)},function(t,n,e){function r(t){function n(){return{paced:y,rate:g,deterministic:w,time:_,master:b,port:x,federateCount:O}}function e(t){if(R||t.master)for(var n in t)if("master"!==n&&"slave"!==n)throw new Error('Cannot apply configuration option "'+n+'", timer is configured as slave.')}function r(t){function e(t){var e=n();r(t);var o=n();D.emit("config",o,e)}if("deterministic"in t&&(w=t.deterministic?!0:!1),O="federateCount"in t?t.federateCount:0,"paced"in t&&(y=t.paced?!0:!1),"time"in t&&(N=m(t.time),j=f.systemNow(),s(N),_=new Date(N).toISOString()),"rate"in t){var o=Number(t.rate);if(isNaN(o)||0>=o)throw new TypeError("Invalid rate "+JSON.stringify(t.rate)+". Rate must be a positive number");N=D.now(),j=f.systemNow(),g=o}"master"in t&&(R&&(R.destroy(),R=null),b=t.master,null!=t.master&&(R=c(t.master),R.on("change",function(t){e({time:t})}),R.on("config",function(t){e(t)}),R.on("pause",function(t){D.pause()}),R.on("continue",function(t){D["continue"]()}),R.on("error",function(t){D.emit("error",t)}))),"port"in t&&(C&&(C.destroy(),C=null),x=t.port,t.port&&(C=u(D.now,D.config,t.port),C.on("error",function(t){D.emit("error",t)}))),v(),C&&C.broadcastConfig()}function s(t){for(var n=0;n<E.length;n++){var e=E[n];e.type===a.INTERVAL&&l(e,t)}}function l(t,n){t.occurrence=Math.round((n-t.firstTime)/t.interval),t.time=t.firstTime+t.occurrence*t.interval}function p(t){if(E.length>0){for(var n=E.length-1;n>=0&&E[n].time>t.time;)n--;E.splice(n+1,0,t)}else E.push(t)}function d(t,n){function e(){t.type===a.INTERVAL&&k[t.id]&&(t.occurrence++,t.time=t.firstTime+t.occurrence*t.interval,p(t)),delete k[t.id],n&&n()}k[t.id]=t,q[t.time]="undefined"!=typeof q[t.time]?q[t.time]+1:1,D.getFederateCount();try{0==t.callback.length?(t.callback(),e()):t.callback(e)}catch(r){i(D,"error")?D.emit("error",r):console.log("Error",r),e()}}function h(t){for(var n=0;n<E.length&&(E[n].time<=t||!isFinite(E[n].time));)n++;var e=E.splice(0,n);return 0==w&&f.shuffle(e),e}function v(){function t(){function t(){var e=n.shift();e?d(e,t):v()}y||(N=e>N&&isFinite(e)?e:N);var n=h(e);y?(n.forEach(function(t){d(t)}),v()):t()}if(y||!(Object.keys(k).length>0)){var n=E[0];if(S&&(clearTimeout(S),S=null),T&&n){var e=n.time,r=e-D.now(),o=y?r/g:0;S=setTimeout(t,Math.round(o))}}}function m(t){var n="number"==typeof t?t:t instanceof Date?t.valueOf():new Date(t).valueOf();if(isNaN(n))throw new TypeError("Invalid date "+JSON.stringify(t)+". Date, number, or ISOString expected");return n}var y=!0,g=1,w=!0,_=null,b=null,x=null,O=0,T=!1,j=null,N=f.systemNow(),E=[],k={},S=null,I=0,C=null,R=null,D=o({});D.config=function(t){return t&&(e(t),r(t)),n()},D.now=function(){if(y){if(T){var t=f.systemNow()-j,n=t*g;return N+n}return N}return N},D["continue"]=function(){j=f.systemNow(),T=!0,v()},D.pause=function(){N=D.now(),j=null,T=!1,v()},D.getTime=function(){return new Date(D.now())},D.valueOf=D.getTime,D.toString=function(){return D.getTime().toString()},D.setTimeout=function(t,n){var e=I++,r=D.now()+n;if(isNaN(r))throw new TypeError("delay must be a number");return p({id:e,type:a.TIMEOUT,time:r,callback:t}),v(),e},D.setTrigger=function(t,n){var e=I++,r=m(n);return p({id:e,type:a.TRIGGER,time:r,callback:t}),v(),e},D.setInterval=function(t,n,e){var r=I++,o=Number(n);if(isNaN(o))throw new TypeError("interval must be a number");(0>o||!isFinite(o))&&(o=0);var i=void 0!=e?m(e):null,u=D.now(),c=null!=i?i:u+o,f={id:r,type:a.INTERVAL,interval:o,time:c,firstTime:null!=i?i:c,occurrence:0,callback:t};return u>c&&l(f,u),p(f),v(),r},D.clearTimeout=function(t){if(k[t])return void delete k[t];for(var n=0;n<E.length;n++)if(E[n].id===t){E.splice(n,1),v();break}},D.clearTrigger=D.clearTimeout,D.clearInterval=D.clearTimeout,D.list=function(){return E.map(function(t){return t.id})},D.clear=function(){k={},E=[],v()},D.destroy=function(){D.clear(),R&&R.destroy(),C&&C.destroy(),D.emit("destroy")},D.getFederateCount=function(){return n().federateCount};var q={};return Object.defineProperty(D,"running",{get:function(){return T}}),D.config(t),D["continue"](),D}var o=e(2),i=e(17),u=e(19).createMaster,c=e(35).createSlave,f=e(38),a={TIMEOUT:0,INTERVAL:1,TRIGGER:2};t.exports=r},function(t,n,e){"use strict";var r,o,i,u,c,f,a,s=e(3),l=e(16),p=Function.prototype.apply,d=Function.prototype.call,h=Object.create,v=Object.defineProperty,m=Object.defineProperties,y=Object.prototype.hasOwnProperty,g={configurable:!0,enumerable:!1,writable:!0};r=function(t,n){var e;return l(n),y.call(this,"__ee__")?e=this.__ee__:(e=g.value=h(null),v(this,"__ee__",g),g.value=null),e[t]?"object"==typeof e[t]?e[t].push(n):e[t]=[e[t],n]:e[t]=n,this},o=function(t,n){var e,o;return l(n),o=this,r.call(this,t,e=function(){i.call(o,t,e),p.call(n,this,arguments)}),e.__eeOnceListener__=n,this},i=function(t,n){var e,r,o,i;if(l(n),!y.call(this,"__ee__"))return this;if(e=this.__ee__,!e[t])return this;if(r=e[t],"object"==typeof r)for(i=0;o=r[i];++i)(o===n||o.__eeOnceListener__===n)&&(2===r.length?e[t]=r[i?0:1]:r.splice(i,1));else(r===n||r.__eeOnceListener__===n)&&delete e[t];return this},u=function(t){var n,e,r,o,i;if(y.call(this,"__ee__")&&(o=this.__ee__[t]))if("object"==typeof o){for(e=arguments.length,i=new Array(e-1),n=1;e>n;++n)i[n-1]=arguments[n];for(o=o.slice(),n=0;r=o[n];++n)p.call(r,this,i)}else switch(arguments.length){case 1:d.call(o,this);break;case 2:d.call(o,this,arguments[1]);break;case 3:d.call(o,this,arguments[1],arguments[2]);break;default:for(e=arguments.length,i=new Array(e-1),n=1;e>n;++n)i[n-1]=arguments[n];p.call(o,this,i)}},c={on:r,once:o,off:i,emit:u},f={on:s(r),once:s(o),off:s(i),emit:s(u)},a=m({},f),t.exports=n=function(t){return null==t?h(a):m(Object(t),f)},n.methods=c},function(t,n,e){"use strict";var r,o=e(4),i=e(11),u=e(12),c=e(13);r=t.exports=function(t,n){var e,r,u,f,a;return arguments.length<2||"string"!=typeof t?(f=n,n=t,t=null):f=arguments[2],null==t?(e=u=!0,r=!1):(e=c.call(t,"c"),r=c.call(t,"e"),u=c.call(t,"w")),a={value:n,configurable:e,enumerable:r,writable:u},f?o(i(f),a):a},r.gs=function(t,n,e){var r,f,a,s;return"string"!=typeof t?(a=e,e=n,n=t,t=null):a=arguments[3],null==n?n=void 0:u(n)?null==e?e=void 0:u(e)||(a=e,e=void 0):(a=n,n=e=void 0),null==t?(r=!0,f=!1):(r=c.call(t,"c"),f=c.call(t,"e")),s={get:n,set:e,configurable:r,enumerable:f},a?o(i(a),s):s}},function(t,n,e){"use strict";t.exports=e(5)()?Object.assign:e(6)},function(t,n){"use strict";t.exports=function(){var t,n=Object.assign;return"function"!=typeof n?!1:(t={foo:"raz"},n(t,{bar:"dwa"},{trzy:"trzy"}),t.foo+t.bar+t.trzy==="razdwatrzy")}},function(t,n,e){"use strict";var r=e(7),o=e(10),i=Math.max;t.exports=function(t,n){var e,u,c,f=i(arguments.length,2);for(t=Object(o(t)),c=function(r){try{t[r]=n[r]}catch(o){e||(e=o)}},u=1;f>u;++u)n=arguments[u],r(n).forEach(c);if(void 0!==e)throw e;return t}},function(t,n,e){"use strict";t.exports=e(8)()?Object.keys:e(9)},function(t,n){"use strict";t.exports=function(){try{return Object.keys("primitive"),!0}catch(t){return!1}}},function(t,n){"use strict";var e=Object.keys;t.exports=function(t){return e(null==t?t:Object(t))}},function(t,n){"use strict";t.exports=function(t){if(null==t)throw new TypeError("Cannot use null or undefined");return t}},function(t,n){"use strict";var e=Array.prototype.forEach,r=Object.create,o=function(t,n){var e;for(e in t)n[e]=t[e]};t.exports=function(t){var n=r(null);return e.call(arguments,function(t){null!=t&&o(Object(t),n)}),n}},function(t,n){"use strict";t.exports=function(t){return"function"==typeof t}},function(t,n,e){"use strict";t.exports=e(14)()?String.prototype.contains:e(15)},function(t,n){"use strict";var e="razdwatrzy";t.exports=function(){return"function"!=typeof e.contains?!1:e.contains("dwa")===!0&&e.contains("foo")===!1}},function(t,n){"use strict";var e=String.prototype.indexOf;t.exports=function(t){return e.call(this,t,arguments[1])>-1}},function(t,n){"use strict";t.exports=function(t){if("function"!=typeof t)throw new TypeError(t+" is not a function");return t}},function(t,n,e){"use strict";var r=e(18),o=e(10),i=Object.prototype.hasOwnProperty;t.exports=function(t){var n;return o(t),n=arguments[1],arguments.length>1?i.call(t,"__ee__")&&Boolean(t.__ee__[n]):t.hasOwnProperty("__ee__")&&!r(t.__ee__)}},function(t,n,e){"use strict";var r=e(10),o=Object.prototype.propertyIsEnumerable;t.exports=function(t){var n;r(t);for(n in t)if(o.call(t,n))return!1;return!0}},function(t,n,e){var r=e(20),o=e(22),i=e(33)("hypertimer:master");n.createMaster=function(t,n,e){function u(){var t=n();return delete t.time,delete t.master,delete t.port,t.federateCount=c.clients.length,t}var c=new r.Server({port:e}),f={},a={};return c.on("connection",function(n){i("new connection");var e=o(n);e.on("time",function(n,e){var r=t();if("undefined"==typeof a[n]?(c.broadcast("pause",n),a[n]=1):a[n]=a[n]+1,i("federates done: "+a[n]+" of "+u().federateCount),i("queued time "+new Date(r).toISOString()),"undefined"==typeof f[n]?f[n]=[e]:f[n].push(e),a[n]==u().federateCount){for(var o=0;o<f[n].length;o++)f[n][o](r),i("send time "+new Date(r).toISOString());delete f[n],delete a[n],c.broadcast("continue",n)}}),n.on("close",function(){for(var t=0;t<c.clients.length;t++)if(c.clients[t]==n){c.clients.splice(t,1);break}}),n.emitter=e,c.broadcastConfig()}),c.broadcastConfig=function(){var t=u();i("send config",t),c.broadcast("config",t)},c.broadcast=function(t,n){i("broadcast",t,n),c.clients.forEach(function(e){e.emitter.send(t,n)})},c.destroy=function(){c.close(),i("destroyed")},i("listening at ws://localhost:"+e),c}},function(t,n,e){t.exports="undefined"==typeof window||"undefined"==typeof window.WebSocket?e(21):window.WebSocket},function(n,e){n.exports=t},function(t,n,e){var r=e(2),o=e(23),i=e(33)("hypertimer:socket"),u=6e4;t.exports=function(t){function n(n,e){var r={event:n,data:e};i("send",r),t.send(JSON.stringify(r))}function e(n,e){return new o(function(r,o){var f=c();"undefined"==typeof e&&(e=f);var s={event:n,id:f,data:e};a[f]={resolve:r,reject:o,timeout:setTimeout(function(){delete a[f],o(new Error("Timeout"))},u)},i("request",s),t.send(JSON.stringify(s))})["catch"](function(t){console.log("ERROR",t)})}function c(){return s++}var f=r({socket:t,send:n,request:e});t.onmessage=function(n){var e=n.data,r=JSON.parse(e);i("receive",r);var o=a[r.id];o?(clearTimeout(o.timeout),delete a[r.id],o.resolve(r.data)):"id"in r?f.emit(r.event,r.data,function(n){var e={id:r.id,data:n};t.readyState===t.OPEN||t.readyState===t.CONNECTING?(i("reply",e),t.send(JSON.stringify(e))):i("cancel reply",e,"(socket is closed)")}):f.emit(r.event,r.data)};var a={},s=0;return f}},function(t,n,e){t.exports="undefined"==typeof window||"undefined"==typeof window.Promise?e(24):window.Promise},function(t,n,e){"use strict";t.exports=e(25)},function(t,n,e){"use strict";t.exports=e(26),e(28),e(29),e(30),e(31)},function(t,n,e){"use strict";function r(){}function o(t){try{return t.then}catch(n){return m=n,y}}function i(t,n){try{return t(n)}catch(e){return m=e,y}}function u(t,n,e){try{t(n,e)}catch(r){return m=r,y}}function c(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._37=0,this._12=null,this._59=[],t!==r&&h(t,this)}function f(t,n,e){return new t.constructor(function(o,i){var u=new c(r);u.then(o,i),a(t,new d(n,e,u))})}function a(t,n){for(;3===t._37;)t=t._12;return 0===t._37?void t._59.push(n):void v(function(){var e=1===t._37?n.onFulfilled:n.onRejected;if(null===e)return void(1===t._37?s(n.promise,t._12):l(n.promise,t._12));var r=i(e,t._12);r===y?l(n.promise,m):s(n.promise,r)})}function s(t,n){if(n===t)return l(t,new TypeError("A promise cannot be resolved with itself."));if(n&&("object"==typeof n||"function"==typeof n)){var e=o(n);if(e===y)return l(t,m);if(e===t.then&&n instanceof c)return t._37=3,t._12=n,void p(t);if("function"==typeof e)return void h(e.bind(n),t)}t._37=1,t._12=n,p(t)}function l(t,n){t._37=2,t._12=n,p(t)}function p(t){for(var n=0;n<t._59.length;n++)a(t,t._59[n]);t._59=null}function d(t,n,e){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof n?n:null,this.promise=e}function h(t,n){var e=!1,r=u(t,function(t){e||(e=!0,s(n,t))},function(t){e||(e=!0,l(n,t))});e||r!==y||(e=!0,l(n,m))}var v=e(27),m=null,y={};t.exports=c,c._99=r,c.prototype.then=function(t,n){if(this.constructor!==c)return f(this,t,n);var e=new c(r);return a(this,new d(t,n,e)),e}},function(t,n){(function(n){"use strict";function e(t){c.length||(u(),f=!0),c[c.length]=t}function r(){for(;a<c.length;){var t=a;if(a+=1,c[t].call(),a>s){for(var n=0,e=c.length-a;e>n;n++)c[n]=c[n+a];c.length-=a,a=0}}c.length=0,a=0,f=!1}function o(t){var n=1,e=new l(t),r=document.createTextNode("");return e.observe(r,{characterData:!0}),function(){n=-n,r.data=n}}function i(t){return function(){function n(){clearTimeout(e),clearInterval(r),t()}var e=setTimeout(n,0),r=setInterval(n,50)}}t.exports=e;var u,c=[],f=!1,a=0,s=1024,l=n.MutationObserver||n.WebKitMutationObserver;u="function"==typeof l?o(r):i(r),e.requestFlush=u,e.makeRequestCallFromTimer=i}).call(n,function(){return this}())},function(t,n,e){"use strict";var r=e(26);t.exports=r,r.prototype.done=function(t,n){var e=arguments.length?this.then.apply(this,arguments):this;e.then(null,function(t){setTimeout(function(){throw t},0)})}},function(t,n,e){"use strict";var r=e(26);t.exports=r,r.prototype["finally"]=function(t){return this.then(function(n){return r.resolve(t()).then(function(){return n})},function(n){return r.resolve(t()).then(function(){throw n})})}},function(t,n,e){"use strict";function r(t){var n=new o(o._99);return n._37=1,n._12=t,n}var o=e(26);t.exports=o;var i=r(!0),u=r(!1),c=r(null),f=r(void 0),a=r(0),s=r("");o.resolve=function(t){if(t instanceof o)return t;if(null===t)return c;if(void 0===t)return f;if(t===!0)return i;if(t===!1)return u;if(0===t)return a;if(""===t)return s;if("object"==typeof t||"function"==typeof t)try{var n=t.then;if("function"==typeof n)return new o(n.bind(t))}catch(e){return new o(function(t,n){n(e)})}return r(t)},o.all=function(t){var n=Array.prototype.slice.call(t);return new o(function(t,e){function r(u,c){if(c&&("object"==typeof c||"function"==typeof c)){if(c instanceof o&&c.then===o.prototype.then){for(;3===c._37;)c=c._12;return 1===c._37?r(u,c._12):(2===c._37&&e(c._12),void c.then(function(t){r(u,t)},e))}var f=c.then;if("function"==typeof f){var a=new o(f.bind(c));return void a.then(function(t){r(u,t)},e)}}n[u]=c,0===--i&&t(n)}if(0===n.length)return t([]);for(var i=n.length,u=0;u<n.length;u++)r(u,n[u])})},o.reject=function(t){return new o(function(n,e){e(t)})},o.race=function(t){return new o(function(n,e){t.forEach(function(t){o.resolve(t).then(n,e)})})},o.prototype["catch"]=function(t){return this.then(null,t)}},function(t,n,e){"use strict";var r=e(26),o=e(32);t.exports=r,r.denodeify=function(t,n){return n=n||1/0,function(){var e=this,o=Array.prototype.slice.call(arguments,0,n>0?n:0);return new r(function(n,r){o.push(function(t,e){t?r(t):n(e)});var i=t.apply(e,o);!i||"object"!=typeof i&&"function"!=typeof i||"function"!=typeof i.then||n(i)})}},r.nodeify=function(t){return function(){var n=Array.prototype.slice.call(arguments),e="function"==typeof n[n.length-1]?n.pop():null,i=this;try{return t.apply(this,arguments).nodeify(e,i)}catch(u){if(null===e||"undefined"==typeof e)return new r(function(t,n){n(u)});o(function(){e.call(i,u)})}}},r.prototype.nodeify=function(t,n){return"function"!=typeof t?this:void this.then(function(e){o(function(){t.call(n,null,e)})},function(e){o(function(){t.call(n,e)})})}},function(t,n,e){"use strict";function r(){if(f.length)throw f.shift()}function o(t){var n;n=c.length?c.pop():new i,n.task=t,u(n)}function i(){this.task=null}var u=e(27),c=[],f=[],a=u.makeRequestCallFromTimer(r);t.exports=o,i.prototype.call=function(){try{this.task.call()}catch(t){o.onerror?o.onerror(t):(f.push(t),a())}finally{this.task=null,c[c.length]=this}}},function(t,n,e){var r="undefined"!=typeof window?window.Debug:e(34);t.exports=r||function(){return function(){}}},function(t,e){t.exports=n},function(t,n,e){var r=e(20),o=e(23),i=e(33)("hypertimer:slave"),u=e(22),c=e(36),f=e(37),a=36e5,s=1e3,l=5;n.createSlave=function(t){function n(){function t(){var t=null;return v?o.resolve(t):e(d).then(function(n){t=n})["catch"](function(t){console.log(t)}).then(function(){return f.wait(s)}).then(function(){return t})}return f.repeat(t,l).then(function(t){i("latencies",t);var n=t.filter(function(t){return null!==t}),e=c.median(n)+c.std(n),r=n.filter(function(t){return e>t});return r.length>0?c.mean(r):null}).then(function(t){return v?o.resolve(null):d.request("time").then(function(n){var e=n+t;return d.emit("change",e),e})})["catch"](function(t){d.emit("error",t)})}function e(t){var n=Date.now();return t.request("time").then(function(e){var r=Date.now(),o=(r-n)/2,i=e+o;return h&&(h=!1,t.emit("change",i)),o})}var p=new r(t),d=u(p),h=!0,v=!1,m=null;return p.onopen=function(){i("connected"),n(),m=setInterval(n,a)},d.destroy=function(){v=!0,clearInterval(m),m=null,p.close(),i("destroyed")},d}},function(t,n){n.compare=function(t,n){return t>n?1:n>t?-1:0},n.add=function(t,n){return t+n},n.sum=function(t){return t.reduce(n.add)},n.mean=function(t){return n.sum(t)/t.length},n.std=function(t){return Math.sqrt(n.variance(t))},n.variance=function(t){if(t.length<2)return 0;var e=n.mean(t);return t.map(function(t){return Math.pow(t-e,2)}).reduce(n.add)/(t.length-1)},n.median=function(t){if(t.length<2)return t[0];var e=t.slice().sort(n.compare);return e.length%2===0?(t[t.length/2-1]+t[t.length/2])/2:t[(t.length-1)/2]}},function(t,n,e){var r=e(23);n.wait=function(t){return new r(function(n){setTimeout(n,t)})},n.repeat=function(t,n){return new r(function(e,r){function o(){n>i?(i++,t().then(function(t){u.push(t),o()})):e(u)}var i=0,u=[];o()})},n.whilst=function(t,n){return new r(function(e,r){function o(){t()?n().then(function(){o()}):e()}o()})}},function(t,n){"function"==typeof Date.now?n.systemNow=function(){return Date.now()}:n.systemNow=function(){return(new Date).valueOf()},n.shuffle=function(t){for(var n,e,r=t.length;r;n=Math.floor(Math.random()*r),e=t[--r],t[r]=t[n],t[n]=e);return t}}])});
//# sourceMappingURL=hypertimer.map